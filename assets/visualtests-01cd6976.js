import{g as ae,r as g,j as c,c as ne}from"./index-81f15401.js";import{m as E,b as re,l as O,d as se}from"./utils-37ec2d2d.js";const oe=[{name:"taiwan-z8",description:"Compare the appearance of highways",tags:["highway","cjk","tw"],center:[121.333,24.32],zoom:8},{name:"taiwan-z16-buildings",description:"Compare the appearance of buildings",tags:["building","cjk","tw"],center:[121.4818,25.0271],zoom:16},{name:"world",description:"Country labels",tags:[],center:[121,25],zoom:4},{name:"world2",description:"Country labels",tags:[],center:[0,0],zoom:2},{name:"zurich-bridges",description:"Pedestrian bridge tagged as area",tags:["bridge","ch"],center:[8.54252,47.376925],zoom:17},{name:"brazil-boundaries",description:"admin boundaries other than Brasilia should be visible at zoom 6",tags:["boundaries"],center:[-49.092,-15.092],zoom:6},{name:"kenya-boundaries",description:"admin boundaries level 5 around Nairobi should not appear broken",tags:["boundaries"],center:[37.382,-1.592],zoom:7},{name:"colombia-rivers",description:"water features west of Bogota should not be broken",tags:["water"],center:[-74.422,4.62],zoom:7.8},{name:"river-thames",description:"River Thames should not have pieces missing",tags:["water"],center:[-.3,51.4],zoom:8.9},{name:"landuse-urban-green",description:"show village_green, allotments, playgrounds",tags:[],center:[7.3217,51.50406],zoom:15},{name:"san-francisco-piers",description:"piers in the roads layer are rendered",tags:["roads"],center:[-122.440512,37.807891],zoom:16},{name:"edwards-afb",description:"edwards air force base runways",tags:["landuse"],center:[-118.0726,34.8328],zoom:10}];var le=ce;const ie={threshold:.1,includeAA:!1,alpha:.1,aaColor:[255,255,0],diffColor:[255,0,0],diffColorAlt:null,diffMask:!1};function ce(e,t,a,n,r,s){if(!I(e)||!I(t)||a&&!I(a))throw new Error("Image data: Uint8Array, Uint8ClampedArray or Buffer expected.");if(e.length!==t.length||a&&a.length!==e.length)throw new Error("Image sizes do not match.");if(e.length!==n*r*4)throw new Error("Image data size does not match width/height.");s=Object.assign({},ie,s);const l=n*r,d=new Uint32Array(e.buffer,e.byteOffset,l),m=new Uint32Array(t.buffer,t.byteOffset,l);let i=!0;for(let o=0;o<l;o++)if(d[o]!==m[o]){i=!1;break}if(i){if(a&&!s.diffMask)for(let o=0;o<l;o++)X(e,4*o,s.alpha,a);return 0}const h=35215*s.threshold*s.threshold;let f=0;for(let o=0;o<r;o++)for(let u=0;u<n;u++){const p=(o*n+u)*4,b=W(e,t,p,p);Math.abs(b)>h?!s.includeAA&&(F(e,u,o,n,r,t)||F(t,u,o,n,r,e))?a&&!s.diffMask&&U(a,p,...s.aaColor):(a&&U(a,p,...b<0&&s.diffColorAlt||s.diffColor),f++):a&&(s.diffMask||X(e,p,s.alpha,a))}return f}function I(e){return ArrayBuffer.isView(e)&&e.constructor.BYTES_PER_ELEMENT===1}function F(e,t,a,n,r,s){const l=Math.max(t-1,0),d=Math.max(a-1,0),m=Math.min(t+1,n-1),i=Math.min(a+1,r-1),h=(a*n+t)*4;let f=t===l||t===m||a===d||a===i?1:0,o=0,u=0,p,b,v,w;for(let y=l;y<=m;y++)for(let R=d;R<=i;R++){if(y===t&&R===a)continue;const j=W(e,e,h,(R*n+y)*4,!0);if(j===0){if(f++,f>2)return!1}else j<o?(o=j,p=y,b=R):j>u&&(u=j,v=y,w=R)}return o===0||u===0?!1:A(e,p,b,n,r)&&A(s,p,b,n,r)||A(e,v,w,n,r)&&A(s,v,w,n,r)}function A(e,t,a,n,r){const s=Math.max(t-1,0),l=Math.max(a-1,0),d=Math.min(t+1,n-1),m=Math.min(a+1,r-1),i=(a*n+t)*4;let h=t===s||t===d||a===l||a===m?1:0;for(let f=s;f<=d;f++)for(let o=l;o<=m;o++){if(f===t&&o===a)continue;const u=(o*n+f)*4;if(e[i]===e[u]&&e[i+1]===e[u+1]&&e[i+2]===e[u+2]&&e[i+3]===e[u+3]&&h++,h>2)return!0}return!1}function W(e,t,a,n,r){let s=e[a+0],l=e[a+1],d=e[a+2],m=e[a+3],i=t[n+0],h=t[n+1],f=t[n+2],o=t[n+3];if(m===o&&s===i&&l===h&&d===f)return 0;m<255&&(m/=255,s=C(s,m),l=C(l,m),d=C(d,m)),o<255&&(o/=255,i=C(i,o),h=C(h,o),f=C(f,o));const u=S(s,l,d),p=S(i,h,f),b=u-p;if(r)return b;const v=V(s,l,d)-V(i,h,f),w=Y(s,l,d)-Y(i,h,f),y=.5053*b*b+.299*v*v+.1957*w*w;return u>p?-y:y}function S(e,t,a){return e*.29889531+t*.58662247+a*.11448223}function V(e,t,a){return e*.59597799-t*.2741761-a*.32180189}function Y(e,t,a){return e*.21147017-t*.52261711+a*.31114694}function C(e,t){return 255+(e-255)*t}function U(e,t,a,n,r){e[t+0]=a,e[t+1]=n,e[t+2]=r,e[t+3]=255}function X(e,t,a,n){const r=e[t+0],s=e[t+1],l=e[t+2],d=C(S(r,s,l),a*e[t+3]/255);U(n,t,d,d,d)}const fe=ae(le),G=(e,t)=>{const a=new Image,n=new Promise(r=>{a.onload=()=>{e.drawImage(a,0,0),r()}});return a.src=t,n},Q=(e,t,a)=>new Promise(n=>{e.on("idle",()=>{const r=e.getCanvas();n(r.toDataURL())}),e.jumpTo({center:t,zoom:a})}),H=(e,t,a,n,r)=>new E.Map({container:e,interactive:!1,style:{version:8,center:a,zoom:n,glyphs:"https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf",sprite:"https://protomaps.github.io/basemaps-assets/sprites/v4/light",sources:{protomaps:{type:"vector",url:`pmtiles://${t}`,attribution:""}},layers:r}}),z=new URLSearchParams(location.search),x=500*window.devicePixelRatio,de=async(e,t)=>{const[a,n]=await Promise.all([Q(e.leftMap,t.center,t.zoom),Q(e.rightMap,t.center,t.zoom)]);await G(e.leftCtx,a),await G(e.rightCtx,n);const r=e.diffCtx.createImageData(x,x),s=fe(e.leftCtx.getImageData(0,0,x,x).data,e.rightCtx.getImageData(0,0,x,x).data,r.data,x,x,{threshold:.1});return e.diffCtx.putImageData(r,0,0),{pixelsDifferent:s,leftData:a,rightData:n,diffData:e.diffCanvas.toDataURL()}},J=e=>{const t=new URLSearchParams(z);return t.delete("name"),t.delete("tag"),e.name&&t.set("name",e.name),e.tag&&t.set("tag",e.tag),`/visualtests/?${t.toString()}`},ue=async()=>(await(await fetch("https://registry.npmjs.org/protomaps-themes-base",{headers:{Accept:"application/vnd.npm.install-v1+json"}})).json())["dist-tags"].latest;function me(e){const t=g.useRef(null),a=g.useRef(null),n=g.useRef(null);g.useEffect(()=>{if(!t.current||!a.current||!n.current){console.error("DOM element not initialized");return}t.current.src=e.result.rendered.leftData,a.current.src=e.result.rendered.rightData,n.current.src=e.result.rendered.diffData},[e.result]);const r=e.result.example;return c.jsxs("div",{className:"example",children:[c.jsxs("div",{children:[c.jsx("img",{alt:"left",ref:t}),c.jsx("img",{alt:"right",ref:a}),c.jsx("img",{alt:"diff",ref:n})]}),c.jsx("a",{href:J({name:r.name}),children:r.name}),c.jsx("a",{href:`/map/#map=${r.zoom}/${r.center[1]}/${r.center[0]}`,target:"_blank",rel:"noreferrer",children:"(map)"}),c.jsx("span",{children:r.description}),r.tags.map(s=>c.jsx("a",{href:J({tag:s}),children:s},s))]})}function he(){const e=g.useRef(null),t=g.useRef(null),a=g.useRef(null),n=g.useRef(null),r=g.useRef(null),s=g.useRef(null),l=g.useRef(null),[d,m]=g.useState([]),[i,h]=g.useState(["-","-","-","-"]);return g.useEffect(()=>((async()=>{E.getRTLTextPluginStatus()==="unavailable"&&E.setRTLTextPlugin("https://unpkg.com/@mapbox/mapbox-gl-rtl-text@0.2.3/mapbox-gl-rtl-text.min.js",!1);const o=new re;E.addProtocol("pmtiles",o.tile);const u=await(await fetch("https://build-metadata.protomaps.dev/builds.json")).json(),p=`https://build.protomaps.com/${u[u.length-1].key}`,b=z.get("leftTiles")||p,v=z.get("rightTiles")||p,w=z.get("leftStyle")||await ue(),y=z.get("rightStyle"),R=await O(w),j=y?await O(y):se("protomaps","light","en","Latin");h([b,v,w||"npm@latest",y||"local/main"]);const _=z.get("name"),$=z.get("tag");let M=oe;_!==null?M=M.filter(D=>D.name===_):$!==null&&(M=M.filter(D=>D.tags.indexOf($)>=0));const P=M[0];if(!e.current||!t.current||!r.current||!s.current||!l.current){console.error("Page failed to initialize");return}a.current=H(e.current,b,P.center,P.zoom,R),n.current=H(t.current,v,P.center,P.zoom,j);const L=r.current;L.width=x,L.height=x;const k=s.current;k.width=x,k.height=x;const T=l.current;T.width=x,T.height=x;const q=L.getContext("2d",{willReadFrequently:!0}),B=k.getContext("2d",{willReadFrequently:!0}),N=T.getContext("2d",{willReadFrequently:!0});if(!q||!B||!N){console.error("Canvas failed to initialize");return}const Z={leftMap:a.current,rightMap:n.current,leftCtx:q,rightCtx:B,diffCtx:N,diffCanvas:T};for(const D of M){const ee=await de(Z,D);m(te=>[...te,{example:D,rendered:ee}])}})(),()=>{E.removeProtocol("pmtiles"),a.current&&a.current.remove(),n.current&&n.current.remove()}),[]),c.jsxs("div",{className:"visual-tests",children:[c.jsxs("div",{style:{position:"absolute",opacity:0,zIndex:-1},children:[c.jsx("div",{ref:e,className:"map"}),c.jsx("div",{ref:t,className:"map"}),c.jsx("canvas",{ref:r}),c.jsx("canvas",{ref:s}),c.jsx("canvas",{ref:l})]}),c.jsxs("div",{style:{width:"500px",display:"inline-block"},children:["leftTiles=",i[0],c.jsx("br",{}),i[2]]}),c.jsxs("div",{style:{width:"500px",display:"inline-block"},children:["rightTiles=",i[1],c.jsx("br",{}),i[3]]}),d.map(f=>c.jsx(me,{result:f},f.example.name))]})}const K=document.getElementById("root");K&&ne.createRoot(K).render(c.jsx(he,{}));
